Installation instructions
=========================

Prerequisites
-------------

We assume that you already have installed a C++ IDE and if you want to run locally, a local version of LibTorch. You also need CMake (version >=3.21). Most IDEs (e.g., Visual Studio) are supplied with CMake, if you install the right plugins.

Setup
-----

For the easiest setup, provide a ``CMakeUserPresets.json`` in the root directory. Note: ``CMakeUserPresets.json`` in the root directory is ignored by Git. This allows for passing in specific configurations and paths tailored to your local environment. An example file can be found at ``cmake/resources/``. You could copy this to the root directory, and adapt it to your specific needs.

.. hint::
    Visual Studio and other IDEs often hide files and folders that are ignored in Git, in settings you can set ignored files to visible.

The ``CMakeUserPresets.json`` should provide paths to certain dependencies (e.g., ``PyTorch``). You also need to provide ``DYNAPLEX_IO_ROOT_DIR``, which is a local directory where input and output files used and generated by DynaPlex will be stored and retrieved from.

Windows
-------

With the setup in place, compiling the library should be straightforward in most IDEs that support CMake (possibly via a proper extension).


Linux/Snellius
--------------

**0. Download and unzip LibTorch (Only on Snellius):**

    Easiest way to link LibTorch: you can download the LibTorch version for Linux and upload it (still zipped) to your home folder. Next, you can unzip the library:

    .. code-block:: bash

      unzip libtorch-version-name.zip
    
    Please note that you will need to download the CX11 version of LibTorch for Linux (c++11 and later, including C++20 which is what DynaPlex uses), and NOT the Pre-CX11 version, see below screenshot.

    .. figure:: ../assets/images/libtorch.png
       :alt: Linux LibTorch


**1. Initialize Environment and Load Modules (Only on Snellius):**

   .. code-block:: bash

      cd bash
      source loadmodules.sh
      cd .. #back to root

**2. Build:**

   - For a specific preset from CMake user presets (e.g., `LinRel`):

     .. code-block:: bash

        cmake --preset=LinRel  # Other options: LinDeb/ LinDB

   - Compile all code:

     .. code-block:: bash

        cmake --build out/LinRel -- -j12

     Note: The option ``-- -j12`` instructs to parallelize the build.

   - If you encounter the error:

     .. code-block:: text

        CMake Error: Could not read presets from /home/willemvj/DynaPlexPrivate: Unrecognized "version" field

     Your CMake version is not recent enough. On Snellius, you may have forgotten to ``source loadmodules.sh`` to bring the recent CMake version into scope.

   - Compile a specific target (e.g., ``sometarget``). This will only build you specific target, e.g., a target in the ``src``

     .. code-block:: bash

        cmake --build out/LinRel --target sometarget -j12

**3. Run:**
    - Executables may be run from a compute node, that can be obtained as follows:

     .. code-block:: bash
    
        srun -p genoa -c 192 -n 1 -t 00:59:00 --pty /bin/bash
    
    also use srun to then do something on that node. You can alternatively run using the sbatch command, see ``CPU.job`` in the ``bash/`` folder for an example file.
